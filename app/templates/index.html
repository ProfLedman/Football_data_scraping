<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FBref Scraper</title>

  <!-- Tailwind CDN (good for prototype). Replace with compiled Tailwind for production later-->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { glass: 'rgba(255,255,255,0.06)' },
          dropShadow: { 'soft': '0 6px 18px rgba(13, 17, 23, 0.24)' }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">

  <style>
    :root { --glass-bg: rgba(255,255,255,0.06); --glass-border: rgba(255,255,255,0.08); }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      backdrop-filter: blur(8px) saturate(110%);
      -webkit-backdrop-filter: blur(8px) saturate(110%);
      border: 1px solid var(--glass-border);
    }
    .focus-ring:focus {
      outline: 3px solid rgba(99,102,241,0.18);
      outline-offset: 2px;
    }
    @keyframes shimmer { 0% { background-position: -400px 0 } 100% { background-position: 400px 0 } }
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.06) 50%, rgba(255,255,255,0.03) 75%);
      background-size: 800px 100%;
      animation: shimmer 1.2s linear infinite;
    }
    .card-lift { transition: transform .25s ease, box-shadow .25s ease; }
    .card-lift:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(2,6,23,0.35); }
    @media (max-width: 640px) { .desktop-only { display: none; } }
    
    /* Progress bar styles */
    .progress-bar {
      transition: width 0.3s ease;
    }
    .generate-btn {
      transition: all 0.2s ease;
    }
    .generate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .generate-btn.loading {
      background-color: #6b7280 !important;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#060710] via-[#071129] to-[#0f1220] text-slate-100 min-h-screen">

  <div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-xl glass flex items-center justify-center text-2xl text-indigo-300 shadow-soft">
          <i class="fas fa-futbol"></i>
        </div>
        <div>
          <h1 class="text-2xl font-semibold">FBref Scraper</h1>
          <p class="text-slate-400 text-sm">Clean, fast, accessible fixtures explorer</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="dark-toggle" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg glass focus-ring" aria-pressed="false" title="Toggle dark/light">
          <i class="fa-solid fa-moon"></i>
          <span class="desktop-only text-sm text-slate-300">Dark</span>
        </button>
        <nav aria-label="Top actions" class="inline-flex items-center gap-2">
          <button id="export-btn" class="bg-indigo-500 hover:bg-indigo-600 active:scale-95 text-white px-3 py-2 rounded-lg shadow-md focus-ring" title="Export displayed fixtures">Export</button>
        </nav>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Sidebar controls -->
      <aside class="md:col-span-1 glass rounded-2xl p-5 shadow-soft" aria-labelledby="filters-heading">
        <h2 id="filters-heading" class="text-lg font-medium mb-3">Find fixtures</h2>
        <form id="search-form" class="space-y-4" aria-describedby="filters-desc">
          <p id="filters-desc" class="sr-only">Choose date, league and refine results</p>
          <div>
            <label for="date" class="text-sm mb-1 block">Date</label>
            <input id="date" name="date" type="date" class="w-full p-2 rounded-lg bg-transparent border border-slate-700 focus:ring-2 focus:ring-indigo-400 focus:outline-none focus:ring-offset-0 focus:border-indigo-400" aria-label="Select date" />
          </div>
          <div>
            <label for="league" class="text-sm mb-1 block">League</label>
            <select id="league" name="league" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:ring-2 focus:ring-indigo-400 focus:outline-none" aria-label="Select league">
              <option value="">All Leagues</option>
              <option value="9">Premier League</option>
              <option value="12">La Liga</option>
              <option value="11">Serie A</option>
              <option value="20">Bundesliga</option>
              <option value="13">Ligue 1</option>
            </select>
          </div>
          <div>
            <label for="search" class="text-sm mb-1 block">Search teams</label>
            <input id="search" name="search" type="search" placeholder="Team name, stadium, referee..." class="w-full p-2 rounded-lg bg-transparent border border-slate-700 focus:ring-2 focus:ring-indigo-400 focus:outline-none" aria-label="Search fixtures" />
          </div>
          <div class="flex gap-2">
            <button type="submit" id="fetch-btn" class="flex-1 px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white font-medium focus-ring" aria-live="polite">
              <i class="fa-solid fa-magnifying-glass mr-2"></i> Search
            </button>
            <button type="button" id="clear-btn" class="px-4 py-2 rounded-lg border border-slate-700 text-slate-200 hover:bg-slate-800 focus-ring" title="Clear filters">Clear</button>
          </div>
          <div class="mt-2 text-xs text-slate-400">Tip: Use the search to quickly filter teams.</div>
        </form>
        <hr class="my-4 border-slate-700" />
        <div class="flex gap-2">
          <button id="export-csv" class="flex-1 px-3 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white focus-ring"><i class="fa-solid fa-file-csv mr-2"></i>CSV</button>
          <button id="export-xlsx" class="px-3 py-2 rounded-lg bg-amber-500 hover:bg-amber-600 text-slate-900 focus-ring"><i class="fa-solid fa-file-excel mr-2"></i>XLSX</button>
        </div>
      </aside>

      <!-- Fixtures list -->
      <section id="fixtures-panel" class="md:col-span-2">
        <div class="glass rounded-2xl p-4 shadow-soft">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-medium">Fixtures</h2>
            <div class="text-sm text-slate-400">Show matches from selected date &amp; league</div>
          </div>
          
          <!-- Progress and Status Area -->
          <div id="global-status" class="mb-4 hidden">
            <div class="bg-slate-800 rounded-lg p-4">
              <div class="flex justify-between items-center mb-2">
                <span id="status-message" class="font-medium">Generating report...</span>
                <span id="status-percent" class="text-sm">0%</span>
              </div>
              <div class="w-full bg-slate-700 rounded-full h-2">
                <div id="progress-bar" class="bg-indigo-500 h-2 rounded-full progress-bar" style="width: 0%"></div>
              </div>
              <div id="status-details" class="text-xs text-slate-400 mt-1"></div>
            </div>
          </div>

          <div id="status" class="mb-3" aria-live="polite"></div>
          <div class="flex items-center gap-3 mb-4">
            <input id="local-search" placeholder="Filter displayed fixtures" class="flex-1 p-2 rounded-lg bg-transparent border border-slate-700 focus:ring-2 focus:ring-indigo-400 focus:outline-none" aria-label="Filter displayed fixtures" />
            <select id="sort" class="p-2 rounded-lg bg-transparent border border-slate-700" aria-label="Sort fixtures">
              <option value="time">Sort: Kick-off</option>
              <option value="home">Home team</option>
              <option value="away">Away team</option>
            </select>
          </div>
          <div id="fixtures" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div id="empty-state" class="w-full p-8 text-center text-slate-400">
              <i class="fa-regular fa-clock fa-2x mb-3"></i>
              <p>Select a date and click Search to load fixtures.</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-8 text-center text-slate-500 text-sm">Built for prototyping · keyboard accessible · responsive</footer>
  </div>

  <!-- JavaScript Implementation with Null Safety -->
  <script>
    // API Endpoints - match your FastAPI backend
    const API_BASE = window.location.origin;
    const API_FIXTURES = `${API_BASE}/api/fixtures`;
    const API_GENERATE_REPORT = `${API_BASE}/api/generate-report`;
    const API_PROGRESS = `${API_BASE}/api/progress`;
    const API_DOWNLOAD = `${API_BASE}/api/download`;

    // Utility functions
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => Array.from(document.querySelectorAll(selector));

    // Store empty state HTML as constant to avoid DOM issues
    const EMPTY_STATE_HTML = `
      <div class="w-full p-8 text-center text-slate-400">
        <i class="fa-regular fa-clock fa-2x mb-3"></i>
        <p>Select a date and click Search to load fixtures.</p>
      </div>
    `;

    // State management
    let currentFixtures = [];
    let activeTaskId = null;
    let progressInterval = null;

    // Status management
    function showStatus(message, type = 'info') {
      const statusEl = $('#status');
      if (!statusEl) return;
      
      const colors = {
        info: 'text-blue-400',
        success: 'text-green-400',
        warning: 'text-yellow-400',
        error: 'text-red-400'
      };
      statusEl.innerHTML = message ? `<div class="text-sm ${colors[type]}">${message}</div>` : '';
    }

    function showGlobalProgress(percent, message, details = '') {
      const globalStatus = $('#global-status');
      const statusMessage = $('#status-message');
      const statusPercent = $('#status-percent');
      const progressBar = $('#progress-bar');
      const statusDetails = $('#status-details');

      if (!globalStatus || !statusMessage || !statusPercent || !progressBar || !statusDetails) return;

      globalStatus.classList.remove('hidden');
      statusMessage.textContent = message;
      statusPercent.textContent = `${percent}%`;
      progressBar.style.width = `${percent}%`;
      statusDetails.textContent = details;
    }

    function hideGlobalProgress() {
      const globalStatus = $('#global-status');
      if (globalStatus) globalStatus.classList.add('hidden');
    }

    function createSkeletonCards(count = 6) {
      const container = document.createElement('div');
      container.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4';
      for (let i = 0; i < count; i++) {
        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl skeleton glass';
        card.style.height = '140px';
        container.appendChild(card);
      }
      return container;
    }

    // Render fixtures with Generate Report buttons - FIXED NULL SAFETY
    function renderFixtures(fixtures) {
      const container = $('#fixtures');
      if (!container) return;
      
      container.innerHTML = '';

      if (!fixtures || fixtures.length === 0) {
        // Use the constant instead of trying to access removed DOM element
        container.innerHTML = EMPTY_STATE_HTML;
        return;
      }

      fixtures.forEach(fixture => {
        const card = document.createElement('div');
        card.className = 'glass p-4 rounded-2xl card-lift border border-slate-700';
        
        card.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium text-indigo-300 bg-indigo-900/30 px-2 py-1 rounded">${escapeHtml(fixture.league)}</span>
            <span class="text-xs text-slate-400">${escapeHtml(fixture.time)}</span>
          </div>
          
          <div class="flex items-center justify-between mb-4">
            <div class="text-center flex-1">
              <div class="font-bold text-lg">${escapeHtml(fixture.home_team)}</div>
              <div class="text-sm text-slate-400 mt-1">Home</div>
            </div>
            
            <div class="mx-3">
              <div class="text-2xl font-bold text-slate-300">VS</div>
              <div class="text-xs text-slate-500 text-center mt-1">${escapeHtml(fixture.score || 'TBD')}</div>
            </div>
            
            <div class="text-center flex-1">
              <div class="font-bold text-lg">${escapeHtml(fixture.away_team)}</div>
              <div class="text-sm text-slate-400 mt-1">Away</div>
            </div>
          </div>
          
          <div class="flex gap-2">
            <button class="generate-btn flex-1 px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg text-sm font-medium focus-ring transition-all"
                    data-match-id="${escapeHtml(fixture.match_id)}"
                    data-match-url="${escapeHtml(fixture.match_url)}">
              <i class="fas fa-download mr-2"></i>Generate Report
            </button>
          </div>
        `;

        // Add event listener to the generate button
        const generateBtn = card.querySelector('.generate-btn');
        if (generateBtn) {
          generateBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            generateMatchReport(fixture.match_id, fixture.match_url, fixture);
          });
        }

        // Card click handler for details
        card.addEventListener('click', () => {
          showFixtureDetails(fixture);
        });

        container.appendChild(card);
      });
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showFixtureDetails(fixture) {
      const details = `
League: ${fixture.league}
Date: ${fixture.date} at ${fixture.time}
Match: ${fixture.home_team} vs ${fixture.away_team}
Score: ${fixture.score || 'Not played yet'}
Venue: ${fixture.venue || 'Unknown'}
      `.trim();
      
      alert(details);
    }

    // API Functions
    async function fetchFixtures(date, league = '') {
      const fixturesEl = $('#fixtures');
      if (!fixturesEl) return;
      
      fixturesEl.innerHTML = '';
      fixturesEl.appendChild(createSkeletonCards());
      showStatus('Loading fixtures...', 'info');

      try {
        const params = new URLSearchParams({ date });
        if (league) params.append('league', league);

        const response = await fetch(`${API_FIXTURES}?${params}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();
        currentFixtures = data.fixtures || [];
        
        renderFixtures(currentFixtures);
        showStatus(`Found ${currentFixtures.length} fixtures`, 'success');
        
      } catch (error) {
        console.error('Error fetching fixtures:', error);
        showStatus('Failed to load fixtures. Please try again.', 'error');
        fixturesEl.innerHTML = `
          <div class="col-span-2 p-6 text-center text-red-400">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <p>Error loading fixtures</p>
            <p class="text-sm mt-2">${error.message}</p>
          </div>
        `;
        currentFixtures = [];
      }
    }

    async function generateMatchReport(matchId, matchUrl, fixture) {
          console.log('DEBUG - Match URL being sent:', matchUrl);
          console.log('DEBUG - Full fixture object:', fixture);
          
          // Validate the URL before sending
          if (!matchUrl || matchUrl === 'string' || !matchUrl.startsWith('/en/matches/')) {
              showStatus('Invalid match URL. Please select a valid fixture.', 'error');
              return;
          }

      // Disable the button and show loading state
      const buttons = $$(`.generate-btn[data-match-id="${matchId}"]`);
      buttons.forEach(btn => {
        if (btn) {
          btn.disabled = true;
          btn.classList.add('loading');
          btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
        }
      });

      try {
        showGlobalProgress(0, 'Starting report generation...', 'Initializing scraping process');
        
        const response = await fetch(API_GENERATE_REPORT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            match_url: matchUrl,
            match_id: matchId,
            format: 'xlsx'
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();
        activeTaskId = data.task_id;
        
        // Start polling for progress
        startProgressPolling(activeTaskId, fixture);
        
      } catch (error) {
        console.error('Error starting report generation:', error);
        showStatus('Failed to start report generation', 'error');
        
        // Re-enable buttons
        buttons.forEach(btn => {
          if (btn) {
            btn.disabled = false;
            btn.classList.remove('loading');
            btn.innerHTML = '<i class="fas fa-download mr-2"></i>Generate Report';
          }
        });
        
        hideGlobalProgress();
      }
    }

    function startProgressPolling(taskId, fixture) {
      if (progressInterval) clearInterval(progressInterval);
      
      progressInterval = setInterval(async () => {
        try {
          const response = await fetch(`${API_PROGRESS}/${taskId}`);
          if (!response.ok) throw new Error('Progress check failed');
          
          const progress = await response.json();
          
          showGlobalProgress(
            progress.progress, 
            progress.message,
            `Task: ${taskId}`
          );

          if (progress.status === 'completed') {
            clearInterval(progressInterval);
            showGlobalProgress(100, 'Report complete! Downloading...', 'Finalizing file');
            
            // Download the report
            setTimeout(() => downloadReport(taskId, fixture), 1000);
            
          } else if (progress.status === 'error') {
            clearInterval(progressInterval);
            showStatus(`Report generation failed: ${progress.message}`, 'error');
            hideGlobalProgress();
            resetGenerateButtons();
          }
          
        } catch (error) {
          console.error('Progress polling error:', error);
        }
      }, 1000);
    }

    function downloadReport(taskId, fixture) {
      try {
        const link = document.createElement('a');
        link.href = `${API_DOWNLOAD}/${taskId}`;
        link.download = `fbref_report_${fixture.home_team}_vs_${fixture.away_team}_${fixture.date}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showStatus('Report downloaded successfully!', 'success');
        
      } catch (error) {
        console.error('Download error:', error);
        showStatus('Download failed. Please try again.', 'error');
      } finally {
        setTimeout(() => {
          hideGlobalProgress();
          resetGenerateButtons();
          activeTaskId = null;
        }, 2000);
      }
    }

    function resetGenerateButtons() {
      $$('.generate-btn').forEach(btn => {
        if (btn) {
          btn.disabled = false;
          btn.classList.remove('loading');
          btn.innerHTML = '<i class="fas fa-download mr-2"></i>Generate Report';
        }
      });
    }

    // Export functionality for fixture lists
    function exportFixtures(format) {
      if (!currentFixtures.length) {
        showStatus('No fixtures to export', 'warning');
        return;
      }

      const headers = ['League', 'Date', 'Time', 'Home Team', 'Away Team', 'Score', 'Match ID'];
      const csvContent = [
        headers.join(','),
        ...currentFixtures.map(f => [
          f.league, f.date, f.time, f.home_team, f.away_team, f.score || '', f.match_id
        ].map(field => `"${String(field || '').replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fbref_fixtures_${new Date().toISOString().split('T')[0]}.${format}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showStatus(`Fixtures exported as ${format.toUpperCase()}`, 'success');
    }

    // Event Listeners with Null Safety
    document.addEventListener('DOMContentLoaded', () => {
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      const dateInput = $('#date');
      if (dateInput) dateInput.value = today;

      // Load today's fixtures automatically
      setTimeout(() => fetchFixtures(today), 500);

      // Search form submission
      const searchForm = $('#search-form');
      if (searchForm) {
        searchForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const date = $('#date')?.value;
          const league = $('#league')?.value;
          
          if (!date) {
            showStatus('Please select a date', 'error');
            return;
          }

          try {
            const params = new URLSearchParams();
            params.append('date', date);
            if (league) params.append('league', league);

            const response = await fetch(`${API_FIXTURES}?${params}`);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }

            const data = await response.json();
            currentFixtures = data.fixtures || [];
            renderFixtures(currentFixtures);
            showStatus(`Found ${currentFixtures.length} fixtures`, 'success');
          } catch (error) {
            console.error('Error:', error);
            showStatus('Failed to load fixtures', 'error');
          }
        });
      }
      
      // Clear button
      const clearBtn = $('#clear-btn');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          if ($('#date')) $('#date').value = today;
          if ($('#league')) $('#league').value = '';
          if ($('#search')) $('#search').value = '';
          fetchFixtures(today, '');
        });
      }

      // Local search filter
      const localSearch = $('#local-search');
      if (localSearch) {
        localSearch.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const filtered = currentFixtures.filter(fixture => 
            fixture.home_team.toLowerCase().includes(searchTerm) ||
            fixture.away_team.toLowerCase().includes(searchTerm) ||
            (fixture.league && fixture.league.toLowerCase().includes(searchTerm))
          );
          renderFixtures(filtered);
        });
      }

      // Sort functionality
      const sortSelect = $('#sort');
      if (sortSelect) {
        sortSelect.addEventListener('change', (e) => {
          const sortBy = e.target.value;
          const sorted = [...currentFixtures].sort((a, b) => {
            switch (sortBy) {
              case 'time': return (a.time || '').localeCompare(b.time || '');
              case 'home': return (a.home_team || '').localeCompare(b.home_team || '');
              case 'away': return (a.away_team || '').localeCompare(b.away_team || '');
              default: return 0;
            }
          });
          renderFixtures(sorted);
        });
      }

      // Export buttons
      const exportCsv = $('#export-csv');
      const exportXlsx = $('#export-xlsx');
      const exportBtn = $('#export-btn');
      
      if (exportCsv) exportCsv.addEventListener('click', () => exportFixtures('csv'));
      if (exportXlsx) exportXlsx.addEventListener('click', () => exportFixtures('xlsx'));
      if (exportBtn) exportBtn.addEventListener('click', () => exportFixtures('csv'));

      // Dark mode toggle
      const darkToggle = $('#dark-toggle');
      if (darkToggle) {
        darkToggle.addEventListener('click', () => {
          document.documentElement.classList.toggle('dark');
          const isDark = document.documentElement.classList.contains('dark');
          darkToggle.setAttribute('aria-pressed', isDark);
          
          const span = darkToggle.querySelector('span');
          const icon = darkToggle.querySelector('i');
          
          if (span) span.textContent = isDark ? 'Light' : 'Dark';
          if (icon) icon.className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        });
      }

      // Keyboard shortcut for search
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
          const searchInput = $('#search');
          if (searchInput) searchInput.focus();
        }
      });
    });
  </script>
</body>
</html>